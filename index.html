<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>üí∞ EXTREME TREASURES üí£</title>
    
    <meta property="og:title" content="Extreme Treasures">
    <meta property="og:description" content="¬°Atrapa tesoros, esquiva bombas y rompe tu propio r√©cord en este adictivo juego de reflejos!">
    <meta property="og:image" content="https://i.postimg.cc/CKPs2Xt0/previsualizacion.jpg">
    <meta property="og:url" content="TU_URL_DEL_JUEGO">
    
    <link rel="apple-touch-icon" href="https://i.postimg.cc/3NR5Tsrm/icono.png">
    <link rel="icon" href="https://i.postimg.cc/3NR5Tsrm/icono.png">
    
    <style>
        /* CSS B√°sico para el Juego de Navegador */
        body { 
            background-color: #4b371c; 
            margin: 0; 
            display: flex; 
            flex-direction: column;
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            font-family: 'Arial', sans-serif;
            color: white;
            -webkit-user-select: none; 
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            touch-action: manipulation; 
        }

        h1 {
            color: #ffcc00; 
            font-size: 2.5em;
            text-align: center;
            margin-bottom: 20px;
            letter-spacing: 5px; 
            text-shadow: 0 0 10px rgba(255, 204, 0, 0.7);
            display: none; 
        }

        canvas { 
            border: 5px solid #00ffff; 
            background-image: url('https://i.postimg.cc/Px2chqKH/Tablero.png'); 
            background-size: cover; 
            background-repeat: no-repeat;
            background-position: center;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
            touch-action: none; 
            display: block; 
        }
        
        /* ESTILOS DEL MEN√ö Y AJUSTES */
        #menu-container, #settings-container, #music-select-container, #how-to-play-container, #about-container, #store-container, #store-music-popup, #pause-menu, #game-over-menu { 
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.85);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(255, 204, 0, 0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 300px;
            max-height: 90vh; 
            overflow-y: auto; 
            z-index: 10;
        }

        /* El popup debe estar por encima del store normal */
        #store-music-popup {
            z-index: 15;
            border: 1px solid #ffcc00; 
        }

        .menu-button, .setting-button {
            background-color: #ffcc00;
            color: #000000;
            border: none;
            padding: 15px 30px;
            margin: 10px 0;
            border-radius: 8px;
            font-size: 1.2em;
            cursor: pointer;
            width: 100%;
            box-sizing: border-box;
            transition: background-color 0.2s, transform 0.1s;
        }

        .menu-button:hover, .setting-button:hover {
            background-color: #ffd700;
            transform: translateY(-2px);
        }
        
        .menu-button[disabled], .menu-button[disabled]:hover {
            background-color: #555 !important;
            color: #ccc !important;
            cursor: not-allowed !important;
            transform: none !important;
        }

        /* --- BOT√ìN TIENDA (IZQUIERDA) --- */
        #store-btn-main {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #ffcc00;
            border: 3px solid #fff;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(255, 204, 0, 0.6);
            transition: transform 0.2s;
            z-index: 20;
        }
        
        #store-btn-main:hover { transform: scale(1.1); }
        #store-btn-main span.emoji { font-size: 30px; }
        #store-btn-main span.text { font-size: 10px; font-weight: bold; color: black; margin-top: -2px; }

        /* --- BOT√ìN DONAR (DERECHA) --- */
        #donate-btn-main {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #ffcc00;
            border: 3px solid #fff;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(255, 204, 0, 0.6);
            transition: transform 0.2s;
            z-index: 20;
        }

        #donate-btn-main:hover { transform: scale(1.1); }
        
        .icon-img-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 2px;
            border: 1px solid #000;
        }
        
        #donate-btn-main span.text { font-size: 10px; font-weight: bold; color: black; margin-top: 2px; }


        /* Estilos lista tienda */
        .store-item {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #ffcc00;
            border-radius: 8px;
            padding: 10px;
            margin: 5px 0;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
        }
        .store-item-name { font-size: 1em; color: white; }
        .store-buy-btn {
            background-color: #00cc00;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .store-buy-btn.locked { background-color: #cc0000; cursor: not-allowed; opacity: 0.5; }
        .store-buy-btn.owned { background-color: #555; cursor: default; }
        
        #wallet-display, #store-wallet-display-popup {
            background-color: rgba(0,0,0,0.6);
            padding: 5px 15px;
            border-radius: 20px;
            border: 1px solid #ffcc00;
            color: #ffcc00;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .setting-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 10px 0;
            font-size: 1.1em;
            color: white;
        }
        
        .info-content p {
            text-align: left;
            margin: 5px 0;
            padding-left: 10px;
        }

        /* --- ESTILOS REDES SOCIALES --- */
        .social-section-title {
            color: #ffcc00;
            margin-top: 20px;
            margin-bottom: 10px;
            border-bottom: 1px solid #ffcc00;
            width: 100%;
            text-align: center;
            padding-bottom: 5px;
        }

        .social-container {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 10px;
        }

        .social-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: white;
            transition: transform 0.2s;
        }

        .social-btn:hover {
            transform: scale(1.1);
        }

        .social-btn img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid #fff;
            margin-bottom: 5px;
            object-fit: cover;
        }

        .social-btn span {
            font-size: 0.9em;
            font-weight: bold;
            color: #ddd;
        }

        /* --- ESTILOS DEL BOT√ìN DE PAUSA --- */
        #controls-container {
            position: absolute;
            top: 25px;
            right: 25px;
            z-index: 5;
        }
        #pause-button {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 1.5em;
            cursor: pointer;
            transition: background-color 0.1s;
            line-height: 1; 
        }
        #pause-button:hover {
            background-color: rgba(255, 255, 255, 0.4);
        }
    </style>
</head>
<body>

    <h1 id="game-title-text">EXTREME<br>TREASURES</h1>

    <div id="store-btn-main" onclick="showStoreMenu()" style="display: none;">
        <span class="emoji">üí∞</span>
        <span class="text">TIENDA</span>
    </div>

    <div id="donate-btn-main" onclick="donateAction()" style="display: none;">
        <img src="https://i.postimg.cc/zfLzw2Mv/channels4_profile.jpg" alt="Donar" class="icon-img-btn">
        <span class="text">DONAR :)</span>
    </div>

    <div id="menu-container">
        <h2>Men√∫ Principal</h2>
        <div id="wallet-display">üí∞ Coins: 0</div>
        <button class="menu-button" onclick="showMusicSelectMenu()">Jugar</button> 
        <button class="menu-button" onclick="showSettings()">Ajustes</button>
        <button class="menu-button" onclick="showHowToPlayMenu()">Como se juega</button>
        <button class="menu-button" onclick="showAboutMenu()">Acerca del juego</button>
        <p id="high-score-display" style="margin-top: 15px; font-size: 1.1em; color: #ffcc00;"></p>
    </div>

    <div id="pause-menu" style="display: none;">
        <h2>PAUSA</h2>
        <button class="menu-button" onclick="togglePause()">REANUDAR</button>
        <button class="menu-button" onclick="showMainMenu()">MEN√ö PRINCIPAL</button>
    </div>

    <div id="game-over-menu" style="display: none;">
        <h2>¬°Juego Terminado!</h2>
        <p id="go-score" style="color: white; font-size: 1.2em; margin: 10px 0;">Puntuaci√≥n: 0</p>
        <p id="go-coins" style="color: #ffcc00; font-size: 1.1em; margin-bottom: 20px;">Coins Totales: 0</p>
        
        <button class="menu-button" onclick="restartGame()">REINICIAR</button>
        <button class="menu-button" onclick="showMainMenu()">MEN√ö PRINCIPAL</button>
    </div>

    <div id="store-container" style="display: none;">
        <h2>üõí TIENDA</h2>
        <div id="store-wallet-display" style="color: #ffcc00; margin-bottom: 15px;">üí∞ Tus Coins: 0</div>
        
        <button class="menu-button" onclick="openMusicStore()">üéµ CANCIONES</button>
        
        <p style="color: #888; font-style: italic; margin-top: 20px;">¬°M√ÅS ART√çCULOS PR√ìXIMAMENTE!</p>
        
        <button class="menu-button" style="margin-top: 20px;" onclick="showMainMenu()">Volver</button>
    </div>

    <div id="store-music-popup" style="display: none;">
        <h2>üéµ Cat√°logo Musical</h2>
        <div id="store-wallet-display-popup">üí∞ Tus Coins: 0</div>
        
        <div id="store-music-list" style="width: 100%; margin-bottom: 15px;">
            </div>
        
        <p style="color: #888; font-style: italic; margin-top: 10px;">¬°M√ÅS CANCIONES PR√ìXIMAMENTE!</p>
        
        <button class="menu-button" style="margin-top: 20px;" onclick="closeMusicStore()">Volver</button>
    </div>

    <div id="music-select-container" style="display: none;">
        <h2>Elige la M√∫sica</h2>
        <button class="menu-button" style="margin-top: 20px;" onclick="showMainMenu()">Volver</button>
    </div>

    <div id="settings-container" style="display: none;">
        <h2>Ajustes</h2>
        
        <div class="setting-label">
            <span>üîä Sonido</span>
            <button class="setting-button" id="sound-toggle" onclick="toggleSound()">
                Desactivar
            </button>
        </div>

        <div class="setting-label">
            <span>üì≥ Vibraci√≥n</span>
            <button class="setting-button" id="vibration-toggle" onclick="toggleVibration()">
                Desactivar
            </button>
        </div>

        <button class="menu-button" style="margin-top: 20px;" onclick="showMainMenu()">Volver</button>
    </div>
    
    <div id="how-to-play-container" style="display: none;">
        <h2>‚ùì ¬øC√≥mo se juega?</h2>
        <div class="info-content">
            <p>¬°Bienvenido a Extreme Treasures! El objetivo es recolectar las riquezas y aumentar tu puntuaci√≥n, mientras evitas las trampas.</p>
            <br>
            <h3>Items Comunes:</h3>
            <p>üíµ Billetes: Puntaje base (+20). Com√∫n.</p>
            <p>ü™ô Moneda de oro: Puntaje medio (+50). Raro.</p>
            <p>üíé Diamante: ¬°El tesoro m√°s valioso! (+1000). Muy raro.</p>
            <p>üí∞ Saco de Monedas: Vale 100 Coins para la TIENDA. (Muy raro).</p> <p>‚ù§Ô∏è Coraz√≥n: Restaura una vida (+1 HP).</p>
            <p>üí∏ Dinero con alas: Resta puntos (-20).</p>
            <p>üí£ Bombas: Peligro. Resta una vida (-1 HP). ¬°Vibra al tocarla!</p>
            <br>
            <h3>Potenciadores y Trampas:</h3>
            <p>‚≠ê Estrella (S√öPER FRENES√ç): Activa el modo Frenes√≠. La velocidad aumenta dr√°sticamente y solo aparecen items de valor durante 10 segundos.</p>
            <p>üëπ Diablo (TRAMPA DEMON√çACA): Activa el modo Trampa. La velocidad aumenta dr√°sticamente y solo aparecen bombas y dinero con alas durante 10 segundos.</p>
        </div>
        <button class="menu-button" style="margin-top: 20px;" onclick="showMainMenu()">Volver al men√∫</button>
    </div>

    <div id="about-container" style="display: none;">
        <h2>‚ú® Acerca del juego</h2>
        <div class="info-content">
            <p>Creado por DX GAMES</p>
            <p><strong>Versi√≥n: v1.4 (Plus)</strong></p> 
            <br>
            
            <h3 class="social-section-title">S√çGUENOS</h3>
            
            <div class="social-container">
                <a href="https://www.facebook.com/profile.php?id=61584974510654" target="_blank" class="social-btn">
                    <img src="https://i.postimg.cc/4xVBSV05/Facebook_Logo_(2019).png" alt="Facebook">
                    <span>Facebook</span>
                </a>
                
                <a href="https://vm.tiktok.com/ZSHKbJmX7EwxF-p1ooR/" target="_blank" class="social-btn">
                    <img src="https://i.postimg.cc/XYtXpyNz/images_(11).jpg" alt="TikTok">
                    <span>TikTok</span>
                </a>
            </div>

            <p style="text-align: center; margin-top: 15px;">¬°Gracias por jugar!</p>
        </div>
        <button class="menu-button" style="margin-top: 20px;" onclick="showMainMenu()">Volver al men√∫</button>
    </div>

    <canvas id="gameCanvas" width="480" height="640" style="display: none;"></canvas>
    
    <div id="controls-container">
        <button id="pause-button" onclick="togglePause()" style="display: none;">‚è∏Ô∏è</button>
    </div>

    <audio id="bgm-player" loop preload="auto">
        Tu navegador no soporta el audio.
    </audio>

    <script>
        // --- 1. Inicializaci√≥n ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const BASE_WIDTH = 480;
        const BASE_HEIGHT = 640;

        function resizeCanvas() {
            const scale = Math.min(
                window.innerWidth / BASE_WIDTH,
                window.innerHeight / BASE_HEIGHT
            );
            canvas.style.width = BASE_WIDTH * scale + 'px';
            canvas.style.height = BASE_HEIGHT * scale + 'px';
        }

        window.addEventListener('resize', resizeCanvas);
        
        const menuContainer = document.getElementById('menu-container');
        const settingsContainer = document.getElementById('settings-container');
        const musicSelectContainer = document.getElementById('music-select-container');
        const howToPlayContainer = document.getElementById('how-to-play-container'); 
        const aboutContainer = document.getElementById('about-container'); 
        const storeContainer = document.getElementById('store-container'); 
        const storeMusicPopup = document.getElementById('store-music-popup'); 
        const pauseMenu = document.getElementById('pause-menu'); // Referencia al men√∫ de pausa
        const gameOverMenu = document.getElementById('game-over-menu'); // Referencia al men√∫ de Game Over
        const pauseButton = document.getElementById('pause-button'); 
        const gameTitleText = document.getElementById('game-title-text'); 
        const highScoreDisplay = document.getElementById('high-score-display'); 
        const storeBtnMain = document.getElementById('store-btn-main'); 
        const donateBtnMain = document.getElementById('donate-btn-main');
        const walletDisplay = document.getElementById('wallet-display');
        const storeWalletDisplay = document.getElementById('store-wallet-display');
        const storeWalletDisplayPopup = document.getElementById('store-wallet-display-popup'); 

        const GAME_WIDTH = canvas.width;
        const GAME_HEIGHT = canvas.height;
        let canvasRect; 
        
        const bgmPlayer = document.getElementById('bgm-player');
        bgmPlayer.volume = 0.3; 
        
        const MENU_BG_IMAGE_URL = 'https://i.postimg.cc/hjpwgGMQ/Fondo_menuprincipal.png';
        const GAME_BG_IMAGE_URL = 'https://i.postimg.cc/TwCSGPQb/Fondo_juego.png';

        // --- INICIO: SECCI√ìN DE AJUSTES Y ESTADO GLOBAL ---
        let gameState = 'MENU'; 
        let audioStarted = false; 
        let highScore = 0; 
        
        // --- SISTEMA DE ECONOM√çA ---
        let playerCoins = 0;
        let unlockedMusicIds = [0, 6]; 

        function loadUserData() {
            const storedScore = localStorage.getItem('extremeTreasuresHighScore');
            highScore = storedScore ? parseInt(storedScore, 10) : 0;
            highScoreDisplay.textContent = `R√©cord: ${highScore}`;

            const storedCoins = localStorage.getItem('dxGamesCoins');
            playerCoins = storedCoins ? parseInt(storedCoins, 10) : 0;
            
            // Actualizar todos los displays de monedas
            walletDisplay.textContent = `üí∞ Coins: ${playerCoins}`;
            storeWalletDisplay.textContent = `üí∞ Tus Coins: ${playerCoins}`;
            storeWalletDisplayPopup.textContent = `üí∞ Tus Coins: ${playerCoins}`;

            const storedMusic = localStorage.getItem('dxGamesUnlockedMusic');
            if (storedMusic) {
                unlockedMusicIds = JSON.parse(storedMusic);
            }
        }

        function saveUserData() {
            localStorage.setItem('dxGamesCoins', playerCoins.toString());
            localStorage.setItem('dxGamesUnlockedMusic', JSON.stringify(unlockedMusicIds));
            
            walletDisplay.textContent = `üí∞ Coins: ${playerCoins}`;
            storeWalletDisplay.textContent = `üí∞ Tus Coins: ${playerCoins}`;
            storeWalletDisplayPopup.textContent = `üí∞ Tus Coins: ${playerCoins}`;
        }

        function saveHighScore() {
            if (bag.score > highScore) {
                highScore = bag.score;
                localStorage.setItem('extremeTreasuresHighScore', highScore.toString());
            }
        }

        // --- DATOS DE M√öSICA ---
        let currentBGMIndex = 0; 
        const BGM_OPTIONS = [
            { id: 0, name: "Pixel Polkka", url: "https://archive.org/download/ievan-polkka-8-bit-chiptune_202512/Ievan%20Polkka%208-Bit%20Chiptune.mp3", price: 0 },
            { id: 1, name: "Pixel Apple", url: "https://archive.org/download/bad-apple-8-bit-tribute-to-nomico-8-bit-universe/Bad%20Apple%21%21%20%5B8%20Bit%20Tribute%20to%20Nomico%5D%20-%208%20Bit%20Universe.mp3", price: 1000 },
            { id: 2, name: "Nostalgia", url: "https://archive.org/download/TetrisThemeMusic/Tetris.mp3", price: 1000 },
            { id: 3, name: "Bot√≠n del Rescate", url: "https://archive.org/download/bella-ciao-8-bit-version/Bella%20Ciao-8%20Bit%20Version.mp3", price: 1000 },
            { id: 4, name: "Ritmo de la Fortuna", url: "https://archive.org/download/katyusha-8-bit_202512/Katyusha%20%288-bit%29.mp3", price: 1000 },
            { id: 5, name: "Ritmo de Asalto", url: "https://archive.org/download/german-military-march-erika-8-bit-cover/German%20Military%20March%20-%20Erika%208%20bit%20cover.mp3", price: 1000 },
            { id: 6, name: "Sin M√∫sica (üîá)", url: null, price: 0 }
        ];
        
        const GAME_VERSION = "v1.4 (Plus)"; 

        let settings = { sound: true, vibration: true };
        const soundToggleBtn = document.getElementById('sound-toggle');
        const vibrationToggleBtn = document.getElementById('vibration-toggle');

        function toggleSound() {
            settings.sound = !settings.sound;
            soundToggleBtn.textContent = settings.sound ? 'Desactivar' : 'Activar';
            if ((gameState === 'PLAYING' || gameState === 'PAUSED') && audioStarted) {
                if (settings.sound && gameState === 'PLAYING') playBGM(); else stopBGM();
            }
        }
        function vibrate(ms) {
            if (!settings.vibration) return;
            if (navigator.vibrate) navigator.vibrate(ms);
        }
        function toggleVibration() {
            settings.vibration = !settings.vibration;
            vibrationToggleBtn.textContent = settings.vibration ? 'Desactivar' : 'Activar';
            if (settings.vibration) vibrate(100);
        }
        
        const SOUNDS = {};
        const AUDIO_URLS = {
            coin: 'https://ejemplo.com/tu/ruta/coin.mp3', 
            life: 'https://ejemplo.com/tu/ruta/life.mp3',
            bomb: 'https://ejemplo.com/tu/ruta/bomb.mp3', 
            powerup: 'https://ejemplo.com/tu/ruta/powerup.mp3',
        };

        function loadAudio() {
            for (const key in AUDIO_URLS) {
                const audio = new Audio(AUDIO_URLS[key]);
                audio.volume = 0.5;
                SOUNDS[key] = audio;
            }
        }
        function playSound(key) {
            if (settings.sound && SOUNDS[key]) {
                const clone = SOUNDS[key].cloneNode();
                clone.play().catch(e => {}); 
            }
        }
        function playBGM() {
            if (settings.sound && BGM_OPTIONS[currentBGMIndex].url) {
                bgmPlayer.src = BGM_OPTIONS[currentBGMIndex].url; 
                bgmPlayer.currentTime = 0; 
                bgmPlayer.play().catch(e => { console.log("Error BGM:", e); });
            } else { stopBGM(); }
        }
        function stopBGM() {
            bgmPlayer.pause();
            bgmPlayer.currentTime = 0;
        }
        loadAudio();

        function togglePause() {
            if (gameState === 'PLAYING') {
                gameState = 'PAUSED';
                stopBGM(); 
                pauseMenu.style.display = 'flex'; // Mostrar men√∫ de pausa HTML
            } else if (gameState === 'PAUSED') {
                gameState = 'PLAYING';
                playBGM();
                pauseMenu.style.display = 'none'; // Ocultar men√∫ de pausa HTML
            }
        }

        // --- FUNCIONES DE VISTA Y MEN√öS ---
        function hideAllMenus() {
            menuContainer.style.display = 'none';
            settingsContainer.style.display = 'none';
            musicSelectContainer.style.display = 'none'; 
            howToPlayContainer.style.display = 'none';
            aboutContainer.style.display = 'none';
            storeContainer.style.display = 'none'; 
            storeMusicPopup.style.display = 'none'; 
            pauseMenu.style.display = 'none';
            gameOverMenu.style.display = 'none';
            
            canvas.style.display = 'none';
            pauseButton.style.display = 'none'; 
            storeBtnMain.style.display = 'none'; 
            donateBtnMain.style.display = 'none'; 
        }

        function setMenuBackground() {
            document.body.style.backgroundImage = `url('${MENU_BG_IMAGE_URL}')`;
            document.body.style.backgroundSize = 'cover';
            document.body.style.backgroundAttachment = 'fixed';
            document.body.style.backgroundPosition = 'left center'; 
        }
        
        function setGameBackground() {
             document.body.style.backgroundImage = `url('${GAME_BG_IMAGE_URL}')`; 
             document.body.style.backgroundSize = 'cover';
             document.body.style.backgroundAttachment = 'fixed';
             document.body.style.backgroundPosition = 'center center';
        }

        function showMainMenu() {
            gameState = 'MENU';
            stopBGM(); 
            setMenuBackground(); 
            gameTitleText.style.display = 'block'; 
            
            hideAllMenus();
            menuContainer.style.display = 'flex';
            storeBtnMain.style.display = 'flex'; 
            donateBtnMain.style.display = 'flex'; 
            
            loadUserData(); 
            
            const buttonsToRemove = musicSelectContainer.querySelectorAll('.menu-button:not([onclick="showMainMenu()"])');
            buttonsToRemove.forEach(btn => btn.remove());
        }
        
        function donateAction() {
            alert('¬°Gracias por tu inter√©s en apoyar a DX GAMES! (Enlace de donaci√≥n pr√≥ximamente)');
        }

        // --- L√ìGICA DE TIENDA Y POPUP ---
        function showStoreMenu() {
            gameState = 'STORE';
            setMenuBackground();
            gameTitleText.style.display = 'block';
            hideAllMenus();
            storeContainer.style.display = 'flex';
            loadUserData(); 
        }

        function openMusicStore() {
            storeContainer.style.display = 'none'; 
            storeMusicPopup.style.display = 'flex'; 
            renderStoreItems(); 
            loadUserData(); 
        }

        function closeMusicStore() {
            storeMusicPopup.style.display = 'none';
            storeContainer.style.display = 'flex';
        }

        function renderStoreItems() {
            const list = document.getElementById('store-music-list');
            list.innerHTML = ''; 

            BGM_OPTIONS.forEach(song => {
                if (song.price === 0) return; 

                const isOwned = unlockedMusicIds.includes(song.id);
                const itemDiv = document.createElement('div');
                itemDiv.className = 'store-item';
                
                let btnHtml = '';
                if (isOwned) {
                    btnHtml = `<button class="store-buy-btn owned">Comprado</button>`;
                } else {
                    const canAfford = playerCoins >= song.price;
                    const btnClass = canAfford ? 'store-buy-btn' : 'store-buy-btn locked';
                    btnHtml = `<button class="${btnClass}" onclick="buyMusic(${song.id}, ${song.price})">Comprar (${song.price} üí∞)</button>`;
                }

                itemDiv.innerHTML = `
                    <span class="store-item-name">${song.name}</span>
                    ${btnHtml}
                `;
                list.appendChild(itemDiv);
            });
        }

        function buyMusic(id, price) {
            if (playerCoins >= price) {
                playerCoins -= price;
                unlockedMusicIds.push(id);
                saveUserData();
                playSound('coin'); 
                vibrate(200);
                renderStoreItems(); 
                alert("¬°Compra exitosa! Ahora puedes usar esta canci√≥n.");
            } else {
                alert("No tienes suficientes Coins. ¬°Juega m√°s para ganar!");
            }
        }

        function showSettings() {
            gameState = 'SETTINGS';
            setMenuBackground(); 
            gameTitleText.style.display = 'block'; 
            hideAllMenus();
            settingsContainer.style.display = 'flex';
            soundToggleBtn.textContent = settings.sound ? 'Desactivar' : 'Activar';
        }
        
        function showMusicSelectMenu() {
            gameState = 'MUSIC_SELECT';
            setMenuBackground(); 
            gameTitleText.style.display = 'block'; 
            hideAllMenus();
            musicSelectContainer.style.display = 'flex';

            const buttonsContainer = musicSelectContainer.querySelector('h2').nextElementSibling;
            if (buttonsContainer && buttonsContainer.tagName !== 'BUTTON') { buttonsContainer.remove(); }

            const optionsHtml = BGM_OPTIONS.map((option, index) => {
                const isUnlocked = unlockedMusicIds.includes(option.id);
                if (!isUnlocked) return ''; 

                return `<button class="menu-button" onclick="playSelectedMusic(${index})">
                            ${option.name} ‚ñ∂Ô∏è
                        </button>`;
            }).join('');
            
            musicSelectContainer.querySelector('h2').insertAdjacentHTML('afterend', `<div id="music-buttons-container">${optionsHtml}</div>`);
        }
        
        function showHowToPlayMenu() {
            gameState = 'INFO';
            setMenuBackground();
            gameTitleText.style.display = 'block'; 
            hideAllMenus();
            howToPlayContainer.style.display = 'flex';
        }

        function showAboutMenu() {
            gameState = 'INFO';
            setMenuBackground();
            gameTitleText.style.display = 'block'; 
            hideAllMenus();
            aboutContainer.style.display = 'flex';
        }

        function playSelectedMusic(index) {
            currentBGMIndex = index;
            startGameLogic(); 
        }

        function startGameLogic() {
            gameState = 'PLAYING';
            setGameBackground(); 
            gameTitleText.style.display = 'none'; 
            hideAllMenus();
            canvas.style.display = 'block';
            pauseButton.style.display = 'block';
            resetGame();
            audioStarted = false; 
            if (!gameLoopId) gameLoopId = requestAnimationFrame(gameLoop);
        }

        function restartGame() {
            startGameLogic();
        }

        function showGameOver() {
            gameState = 'GAMEOVER';
            stopBGM();
            saveHighScore(); 
            saveUserData();
            
            // Llenar datos del men√∫ de Game Over
            document.getElementById('go-score').textContent = `Puntuaci√≥n: ${bag.score}`;
            document.getElementById('go-coins').textContent = `Coins Totales: ${playerCoins}`;
            
            gameOverMenu.style.display = 'flex'; // Mostrar men√∫ HTML
            pauseButton.style.display = 'none';
        }
        
        // --- 1.5. Carga de Imagen de la Bolsa ---
        let bagImage = new Image();
        const BAG_IMAGE_URL = 'https://i.postimg.cc/j5Z9KjvY/Bolsa.png';
        bagImage.src = BAG_IMAGE_URL; 

        // --- 2. Variables del Juego ---
        const BAG_WIDTH = 60; 
        const BAG_HEIGHT = 60; 
        const BAG_SPEED = 7;   
        const MAX_LIFE = 5; 
        let bag = {
            x: (GAME_WIDTH / 2) - (BAG_WIDTH / 2),
            y: GAME_HEIGHT - BAG_HEIGHT - 20, 
            life: 3, 
            score: 0 
        };

        // --- 3. Variables de Dificultad ---
        let currentLevel = 1; 
        const LEVEL_UP_SCORE = 1000; 
        const BASE_SPEED = 2; 
        const SPEED_INCREASE_RATE = 0.05; 
        let items = []; 
        const ITEM_SIZE = 40; 
        let itemSpawnRate = 100; 
        let itemSpawnCounter = 0; 

        let isFrenzyActive = false;
        let isTrapActive = false; 
        let modeEndTime = 0;
        const MODE_DURATION = 10000; 
        const MODE_SPEED_BOOST = 3.0; 

        // --- 4. Tipos de Objetos ---
        const ITEM_TYPES = {
            MONEY_NOTE: { emoji: 'üíµ', value: 20, type: 'good', weight: 8 },
            GOLD_COIN: { emoji: 'ü™ô', value: 50, type: 'good', weight: 4 },
            DIAMOND: { emoji: 'üíé', value: 1000, type: 'good', weight: 0.5 }, 
            STORE_COIN: { emoji: 'üí∞', value: 0, type: 'currency', weight: 0.2 }, 

            HEART: { emoji: '‚ù§Ô∏è', value: 1, type: 'bonus', weight: 1 },
            POWERUP_FRENZY: { emoji: '‚≠ê', value: 0, type: 'powerup', weight: 0.2 }, 
            TRAP_DEMON: { emoji: 'üëπ', value: 0, type: 'trap', weight: 0.1 }, 
            MONEY_WINGS: { emoji: 'üí∏', value: -20, type: 'bad', weight: 3 }, 
            BOMB: { emoji: 'üí£', value: -1, type: 'life_bad', weight: 3 } 
        };
        const totalWeight = Object.values(ITEM_TYPES).reduce((sum, type) => sum + type.weight, 0);

        let rightPressed = false;
        let leftPressed = false;
        let gameLoopId;

        // --- 6. Funciones de Dibujo ---
        function drawBackground() { ctx.clearRect(0, 0, GAME_WIDTH, GAME_HEIGHT); }
        
        function drawBag() {
            ctx.save();
            ctx.globalAlpha = 1.0; 
            if (bagImage.complete && bagImage.naturalWidth !== 0) {
                ctx.drawImage(bagImage, bag.x, bag.y, BAG_WIDTH, BAG_HEIGHT);
            } else {
                ctx.font = `${BAG_WIDTH}px Arial`; ctx.textAlign = 'center';
                ctx.fillText('üí∞', bag.x + BAG_WIDTH / 2, bag.y + BAG_HEIGHT - 5);
            }
            ctx.restore(); 
        }

        function drawItems() {
            ctx.save(); 
            ctx.globalAlpha = 1.0; ctx.shadowColor = 'black'; ctx.shadowBlur = 5; ctx.fillStyle = 'white'; 
            items.forEach(item => {
                ctx.font = `${ITEM_SIZE}px Arial`; ctx.textAlign = 'center';
                ctx.fillText(item.type.emoji, item.x + ITEM_SIZE / 2, item.y + ITEM_SIZE - 5);
            });
            ctx.restore(); 
        }

        function drawHUD() {
            const barX = GAME_WIDTH - 160;
            const barY = 15;
            const barW = 150;
            const barH = 20;
            
            ctx.fillStyle = '#444'; ctx.fillRect(barX, barY, barW, barH);
            const lifeRatio = bag.life / MAX_LIFE;
            ctx.fillStyle = (bag.life <= 1) ? '#ff0000' : '#00cc00'; 
            ctx.fillRect(barX, barY, barW * lifeRatio, barH);
            ctx.strokeStyle = 'white'; ctx.strokeRect(barX, barY, barW, barH);

            ctx.fillStyle = 'white';
            ctx.font = '18px Arial';
            ctx.textAlign = 'left';
            ctx.fillText(`Nivel: ${currentLevel}`, 10, 30); 
            
            // --- CAMBIO: Mostrar el r√©cord en tiempo real ---
            let displayHighScore = Math.max(highScore, bag.score);
            ctx.fillText(`R√©cord: ${displayHighScore}`, 10, 50); 
            
            ctx.fillText(`Puntos: ${bag.score}`, 10, 80); 
            ctx.fillText(`HP: ${bag.life}/${MAX_LIFE}`, barX + barW + 10, barY + 16);
            
            if (isFrenzyActive) {
                const time = Math.ceil((modeEndTime - Date.now()) / 1000);
                ctx.fillStyle = '#ff9900'; ctx.font = '22px Arial'; ctx.textAlign = 'center';
                ctx.fillText(`¬°S√öPER FRENES√ç! ‚ö° ${time}s`, GAME_WIDTH / 2, 45); 
            } else if (isTrapActive) {
                const time = Math.ceil((modeEndTime - Date.now()) / 1000);
                ctx.fillStyle = '#ff0000'; ctx.font = '22px Arial'; ctx.textAlign = 'center';
                ctx.fillText(`¬°TRAMPA DEMON√çACA! üëπ ${time}s`, GAME_WIDTH / 2, 45);
            }

            ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
            ctx.font = '14px Arial'; ctx.textAlign = 'right';
            ctx.fillText(`Versi√≥n: ${GAME_VERSION}`, GAME_WIDTH - 10, GAME_HEIGHT - 10); 

            // Se han eliminado los textos de "PAUSA" y "GAMEOVER" del canvas 
            // ya que ahora se usan men√∫s HTML
            if (gameState === 'PAUSED') {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)'; ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
            }
        }

        // --- 7. L√≥gica ---
        function calculateSpeed() {
            const speedMultiplier = 1 + (currentLevel - 1) * SPEED_INCREASE_RATE;
            let finalMultiplier = speedMultiplier;
            if (isFrenzyActive || isTrapActive) finalMultiplier *= MODE_SPEED_BOOST; 
            return { minSpeed: BASE_SPEED * finalMultiplier, maxSpeed: (BASE_SPEED + 2) * finalMultiplier };
        }

        function updateDifficulty() {
            const newLevel = Math.floor(bag.score / LEVEL_UP_SCORE) + 1;
            if (newLevel > currentLevel) {
                currentLevel = newLevel;
                itemSpawnRate = Math.max(10, itemSpawnRate - 5);
            }
        }
        
        function checkCollision(objA, objB) {
            return objA.x < objB.x + ITEM_SIZE && objA.x + BAG_WIDTH > objB.x &&
                bag.y < objB.y + ITEM_SIZE && bag.y + BAG_HEIGHT > objB.y;
        }

        function spawnItem() {
            let typeToSpawn;
            if (isFrenzyActive) {
                const frenzyWeights = { GOLD_COIN: 5, DIAMOND: 50, MONEY_NOTE: 5, HEART: 1, STORE_COIN: 0.05 }; 
                let randomNum = Math.random() * Object.values(frenzyWeights).reduce((a, b) => a + b, 0);
                for (const key in frenzyWeights) {
                    randomNum -= frenzyWeights[key];
                    if (randomNum <= 0) { typeToSpawn = ITEM_TYPES[key]; break; }
                }
            } else if (isTrapActive) {
                const trapWeights = { BOMB: 10, MONEY_WINGS: 5 };
                let randomNum = Math.random() * Object.values(trapWeights).reduce((a, b) => a + b, 0);
                for (const key in trapWeights) {
                    randomNum -= trapWeights[key];
                    if (randomNum <= 0) { typeToSpawn = ITEM_TYPES[key]; break; }
                }
            } else {
                let randomNum = Math.random() * totalWeight;
                for (const key in ITEM_TYPES) {
                    randomNum -= ITEM_TYPES[key].weight;
                    if (randomNum <= 0) { typeToSpawn = ITEM_TYPES[key]; break; }
                }
            }
            if (!typeToSpawn) return; 

            const x = Math.random() * (GAME_WIDTH - ITEM_SIZE);
            const { minSpeed, maxSpeed } = calculateSpeed();
            const speed = minSpeed + (Math.random() * (maxSpeed - minSpeed));
            items.push({ x: x, y: -ITEM_SIZE, speed: speed, type: typeToSpawn });
        }

        function update() {
            if (gameState !== 'PLAYING') return; 
            if (isFrenzyActive || isTrapActive) {
                if (Date.now() > modeEndTime) { isFrenzyActive = false; isTrapActive = false; modeEndTime = 0; }
            }
            if (rightPressed) bag.x += BAG_SPEED; 
            else if (leftPressed) bag.x -= BAG_SPEED;
            bag.x = Math.max(0, Math.min(bag.x, GAME_WIDTH - BAG_WIDTH));
            bag.life = Math.min(bag.life, MAX_LIFE);

            itemSpawnCounter++;
            const currentSpawnRate = (isFrenzyActive || isTrapActive) ? 30 : itemSpawnRate; 
            if (itemSpawnCounter >= currentSpawnRate) { spawnItem(); itemSpawnCounter = 0; }

            for (let i = items.length - 1; i >= 0; i--) {
                let item = items[i];
                item.y += item.speed;

                if (checkCollision(bag, item)) {
                    if (item.type.type === 'currency') {
                        playerCoins += 100;
                        saveUserData(); 
                        playSound('coin'); 
                    }
                    else if (item.type.type === 'powerup') {
                        isFrenzyActive = true; isTrapActive = false;
                        modeEndTime = Date.now() + MODE_DURATION;
                        playSound('powerup');
                    }
                    else if (item.type.type === 'trap') {
                        isTrapActive = true; isFrenzyActive = false; 
                        modeEndTime = Date.now() + MODE_DURATION;
                        playSound('bomb'); vibrate(400); 
                    }
                    else if (item.type.type === 'good' || item.type.type === 'bad') {
                        bag.score += item.type.value; updateDifficulty(); playSound('coin'); 
                    } 
                    else if (item.type.type === 'bonus') {
                        bag.life += item.type.value; playSound('life'); 
                    }
                    else if (item.type.type === 'life_bad') {
                        bag.life += item.type.value; playSound('bomb'); vibrate(200);
                    }
                    bag.score = Math.max(0, bag.score); 
                    items.splice(i, 1); 
                } 
                else if (item.y > GAME_HEIGHT) { items.splice(i, 1); }
            }

            if (bag.life <= 0) { 
                bag.life = 0; 
                showGameOver(); // Llamamos a la nueva funci√≥n
            }
        }

        function resetGame() {
            bag.x = (GAME_WIDTH / 2) - (BAG_WIDTH / 2);
            bag.life = 3; bag.score = 0;
            items = []; currentLevel = 1; itemSpawnRate = 100; itemSpawnCounter = 0;
            isFrenzyActive = false; isTrapActive = false; modeEndTime = 0;
            audioStarted = false; loadUserData(); 
        }

        document.addEventListener('keydown', (e) => {
            if (gameState === 'PLAYING' || gameState === 'PAUSED') {
                if (e.key === ' ' || e.key.toLowerCase() === 'p') { e.preventDefault(); togglePause(); return; }
            }
            // Se elimin√≥ la tecla 'R' para reiniciar, ahora es por bot√≥n
            if (gameState === 'PLAYING') {
                if (!audioStarted) { playBGM(); audioStarted = true; }
                if (e.key === 'Right' || e.key === 'ArrowRight' || e.key.toLowerCase() === 'd') rightPressed = true;
                else if (e.key === 'Left' || e.key === 'ArrowLeft' || e.key.toLowerCase() === 'a') leftPressed = true;
            }
        });

        document.addEventListener('keyup', (e) => {
            if (gameState === 'PLAYING') {
                if (e.key === 'Right' || e.key === 'ArrowRight' || e.key.toLowerCase() === 'd') rightPressed = false;
                else if (e.key === 'Left' || e.key === 'ArrowLeft' || e.key.toLowerCase() === 'a') leftPressed = false;
            }
        });

        function getTouchX(e) {
            canvasRect = canvas.getBoundingClientRect(); 
            const scaleX = canvas.width / canvasRect.width;
            return (e.touches[0].clientX - canvasRect.left) * scaleX;
        }

        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault(); 
            // Eliminada la l√≥gica de tocar para despausar/reiniciar
            if (gameState === 'PLAYING') {
                if (!audioStarted) { playBGM(); audioStarted = true; }
                const touchX = getTouchX(e);
                bag.x = touchX - (BAG_WIDTH / 2);
                bag.x = Math.max(0, Math.min(bag.x, GAME_WIDTH - BAG_WIDTH));
            }
        });

        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            if (gameState === 'PLAYING') {
                const touchX = getTouchX(e);
                bag.x = touchX - (BAG_WIDTH / 2);
                bag.x = Math.max(0, Math.min(bag.x, GAME_WIDTH - BAG_WIDTH));
            }
        });

        function gameLoop() {
            // El loop se detiene visualmente si estamos en pause o gameover porque el HTML cubre el canvas
            // pero mantenemos el dibujado b√°sico
            if (gameState !== 'MENU' && gameState !== 'SETTINGS' && gameState !== 'MUSIC_SELECT' && gameState !== 'INFO' && gameState !== 'STORE') { 
                drawBackground(); 
                if (gameState === 'PLAYING') update();
                drawBag(); drawItems(); drawHUD();
            }
            gameLoopId = requestAnimationFrame(gameLoop);
        }

        function initGame() {
            if (!canvas || !ctx) return; 
            canvasRect = canvas.getBoundingClientRect(); 
            resizeCanvas();
            loadUserData(); 
            showMainMenu();
            if (!gameLoopId) gameLoopId = requestAnimationFrame(gameLoop);
        }

        document.addEventListener('DOMContentLoaded', initGame); 
        window.addEventListener('resize', () => { if (canvas) canvasRect = canvas.getBoundingClientRect(); });
    </script>
</body>
</html>